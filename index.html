<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>تصميم صورك</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: #f9fdfb;
      margin: 0;
      padding: 0 20px 40px 20px;
      direction: rtl;
      color: #333;
    }
    
    header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: #22c55e;
      color: white;
      padding: 8px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 1000;
      height: 48px;
      box-sizing: border-box;
    }
    
    .header-left, .header-right {
      display: flex;
      align-items: center;
      gap: 18px;
      direction: ltr;
    }
    
    header select {
      padding: 5px 10px;
      border-radius: 6px;
      border: none;
      background: #16a34a;
      color: white;
      cursor: pointer;
      font-weight: bold;
      height: 30px;
    }
    
    header a {
      color: white;
      text-decoration: none;
      transition: color 0.3s;
    }
    
    main {
      padding-top: 70px;
      max-width: 500px;
      margin: auto;
      text-align: center;
    }
    
    h1 {
      font-size: 26px;
      color: #222;
    }
    
    .description {
      font-size: 17px;
      color: #444;
      line-height: 1.4;
      margin-bottom: 30px;
    }
    
    .upload-label {
      display: block;
      margin: 20px auto;
      padding: 14px;
      background-color: #22c55e;
      color: white;
      font-weight: bold;
      border-radius: 16px;
      cursor: pointer;
      width: 220px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      font-size: 18px;
      transition: all 0.3s;
    }
    
    .upload-label:hover {
      background-color: #16a34a;
      transform: scale(1.03);
    }
    
    input[type="file"] {
      display: none;
    }
    
    #descBox {
      width: 100%;
      height: 100px;
      margin: 10px auto;
      padding: 12px;
      border-radius: 12px;
      border: 2px solid #22c55e;
      resize: vertical;
      font-family: 'Cairo';
    }
    
    .btn {
      display: block;
      margin: 15px auto;
      padding: 14px 25px;
      background-color: #22c55e;
      color: white;
      border: none;
      border-radius: 16px;
      font-size: 18px;
      cursor: pointer;
      width: 100%;
      max-width: 300px;
      transition: all 0.3s;
    }
    
    .btn:hover:not(:disabled) {
      background-color: #16a34a;
      transform: scale(1.03);
    }
    
    .btn:disabled {
      background-color: #a0a0a0;
      cursor: not-allowed;
      opacity: 0.7;
    }
    
    .btn.pulse {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(34,197,94,0.6); }
      70% { box-shadow: 0 0 0 15px rgba(34,197,94,0); }
      100% { box-shadow: 0 0 0 0 rgba(34,197,94,0); }
    }
    
    #codeBox {
      font-size: 26px;
      color: green;
      font-weight: bold;
      margin: 20px 0;
    }
    
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #dc2626;
      color: white;
      padding: 10px 20px;
      border-radius: 12px;
      opacity: 0;
      transition: opacity 0.5s;
      z-index: 10000;
    }
    
    .toast.show {
      opacity: 1;
    }
    
    .messaging-panel {
      max-width: 500px;
      margin: 30px auto;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 20px;
      display: none;
    }
    
    .message {
      padding: 10px;
      margin: 10px 0;
      border-radius: 8px;
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
    }
    
    .status-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      margin-right: 5px;
    }
    
    .status-pending {
      background: #fef3c7;
      color: #92400e;
    }
    
    .status-completed {
      background: #d1fae5;
      color: #065f46;
    }
    
    #designResult {
      max-width: 100%;
      margin-top: 15px;
      border: 2px solid #22c55e;
      border-radius: 8px;
      display: none;
    }
    
    .bottom-notice {
      background: #f6ecd4;
      border: 3px solid #cbbf8a;
      border-radius: 18px;
      padding: 15px;
      margin: 20px auto;
      max-width: 460px;
      font-weight: bold;
    }
  </style>
</head>
<body>

<header>
  <div class="header-left">
    <select id="langSelect">
      <option value="ar" selected>عربي</option>
      <option value="en">English</option>
    </select>
    <a href="#about">من نحن؟</a>
  </div>
  <div class="header-right">
    <a href="#"><i class="fab fa-facebook"></i></a>
    <a href="#"><i class="fab fa-twitter"></i></a>
    <a href="#"><i class="fab fa-instagram"></i></a>
  </div>
</header>

<main>
  <h1 id="title">اصنع صورتك بأناقة... نحن هنا لنصمم لك التميز</h1>
  <p class="description" id="description">
    نقدم لك خدمة تصميم صور احترافية وفق ذوقك، وبطريقة سهلة ومجانية — فقط ارفع صورتك، شاهد إعلانًا بسيطًا، واحصل على رمزك الخاص لتبدأ رحلتك مع التصميم.
  </p>
  
  <label for="imageUpload" class="upload-label pulse" id="chooseLabel">اختر صورتك</label>
  <input type="file" id="imageUpload" accept="image/*">
  
  <textarea id="descBox" placeholder="اكتب وصفًا بسيطًا لصورتك هنا... (اختياري)"></textarea>
  
  <button class="btn" id="uploadBtn" disabled>أرسل الصورة الآن</button>
  <button class="btn" id="watchBtn" disabled>شاهد إعلانًا</button>
  <button class="btn" id="getCodeBtn" disabled>احصل على رمزك</button>
  
  <div id="codeBox"></div>
  
  <div class="messaging-panel" id="messagingPanel">
    <h3>مراسلة المصمم</h3>
    <div class="message">
      <span class="status-badge status-pending">قيد الانتظار</span>
      <span id="orderCodeDisplay"></span>
    </div>
    <button class="btn" id="sendToDesignerBtn">
      <i class="fas fa-paper-plane"></i> إرسال الطلب للمصمم
    </button>
    <div id="clientMessages"></div>
    <img id="designResult" alt="التصميم النهائي">
  </div>
  
  <div class="bottom-notice">
    ⚠️ لا ترسل صوراً حساسة لأن المصممين حقيقيون
  </div>
  
  <section id="about" style="margin-top:40px; text-align:right;">
    <h2>من نحن؟</h2>
    <p>نحن فريق متخصص في تحويل صورك العادية إلى تصاميم مذهلة، بدقة عالية ولمسة فنية راقية.</p>
  </section>
</main>

<div class="toast" id="toast"></div>

<script type="module">
  // Import Firebase SDK
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import { 
    getAuth, 
    signInAnonymously,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
  import { 
    getFirestore, 
    doc, 
    setDoc, 
    updateDoc,
    onSnapshot,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
  import { 
    getStorage, 
    ref, 
    uploadBytes, 
    getDownloadURL
  } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-storage.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js";

  // تكوين Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCs5uEbZeiGTqey6Z-YdOa6HNWk_WkKlb4",
    authDomain: "design-for-me.firebaseapp.com",
    projectId: "design-for-me",
    storageBucket: "design-for-me.appspot.com",
    messagingSenderId: "769602104559",
    appId: "1:769602104559:web:bdc7c12db4f956818fff1a",
    measurementId: "G-8ZW2737BP0"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // ============= متغيرات النظام =============
  let lang = 'ar';
  let adWatched = false;
  let imageSelected = false;
  let imageUploaded = false;
  let currentOrder = null;
  let currentImageUrl = '';
  let currentUser = null;
  
  // عناصر الواجهة
  const elements = {
    imageUpload: document.getElementById('imageUpload'),
    uploadBtn: document.getElementById('uploadBtn'),
    watchBtn: document.getElementById('watchBtn'),
    getCodeBtn: document.getElementById('getCodeBtn'),
    codeBox: document.getElementById('codeBox'),
    messagingPanel: document.getElementById('messagingPanel'),
    orderCodeDisplay: document.getElementById('orderCodeDisplay'),
    clientMessages: document.getElementById('clientMessages'),
    designResult: document.getElementById('designResult'),
    toast: document.getElementById('toast'),
    sendToDesignerBtn: document.getElementById('sendToDesignerBtn')
  };
  
  // ============= مصادقة مجهولة =============
  signInAnonymously(auth)
    .then((userCredential) => {
      currentUser = userCredential.user;
    })
    .catch((error) => {
      console.error("Anonymous auth error:", error);
      showToast('حدث خطأ في الاتصال بالخادم');
    });

  // ============= الأحداث =============
  elements.imageUpload.addEventListener('change', handleImageSelect);
  elements.uploadBtn.addEventListener('click', uploadImage);
  elements.watchBtn.addEventListener('click', watchAd);
  elements.getCodeBtn.addEventListener('click', generateCode);
  elements.sendToDesignerBtn.addEventListener('click', sendToDesigner);
  document.getElementById('langSelect').addEventListener('change', changeLanguage);

  // ============= الدوال الأساسية =============
  function handleImageSelect() {
    if (this.files.length > 0) {
      imageSelected = true;
      elements.uploadBtn.disabled = false;
      elements.uploadBtn.classList.add('pulse');
      document.getElementById('chooseLabel').classList.remove('pulse');
      showToast('تم اختيار الصورة. الرجاء الضغط على "أرسل الصورة"');
    }
  }

  async function uploadImage() {
    if (!imageSelected) {
      showToast('يرجى اختيار صورة أولاً');
      return;
    }
    
    const file = elements.imageUpload.files[0];
    const storageRef = ref(storage, `client_uploads/${Date.now()}_${file.name}`);
    
    try {
      showToast('جاري رفع الصورة...');
      const uploadTask = await uploadBytes(storageRef, file);
      currentImageUrl = await getDownloadURL(uploadTask.ref);
      
      imageUploaded = true;
      elements.uploadBtn.disabled = true;
      elements.uploadBtn.classList.remove('pulse');
      elements.watchBtn.disabled = false;
      elements.watchBtn.classList.add('pulse');
      showToast('تم رفع الصورة بنجاح! الرجاء مشاهدة الإعلان');
    } catch (error) {
      showToast('حدث خطأ أثناء رفع الصورة');
      console.error("Upload error:", error);
    }
  }

  function watchAd() {
    if (!imageUploaded) {
      showToast('يرجى رفع الصورة أولاً');
      return;
    }
    
    // محاكاة مشاهدة الإعلان
    showToast('جاري تشغيل الإعلان...');
    
    setTimeout(() => {
      adWatched = true;
      elements.watchBtn.disabled = true;
      elements.watchBtn.classList.remove('pulse');
      elements.getCodeBtn.disabled = false;
      elements.getCodeBtn.classList.add('pulse');
      showToast('شكرًا لمشاهدتك الإعلان! احصل على رمزك الآن');
    }, 5000);
  }

  async function generateCode() {
    if (!adWatched) {
      showToast('يرجى مشاهدة الإعلان أولاً');
      return;
    }
    
    // إنشاء طلب جديد
    const orderCode = Math.floor(100000 + Math.random() * 900000);
    const orderId = 'DSGN-' + Date.now();
    
    const orderData = {
      id: orderId,
      code: orderCode,
      imageUrl: currentImageUrl,
      description: document.getElementById('descBox').value,
      status: 'pending',
      clientId: currentUser?.uid || 'anonymous',
      createdAt: serverTimestamp(),
      adWatched: true
    };
    
    try {
      await setDoc(doc(db, 'design_orders', orderId), orderData);
      
      currentOrder = orderData;
      elements.codeBox.textContent = orderCode;
      elements.orderCodeDisplay.textContent = `رمز طلبك: ${orderCode}`;
      elements.messagingPanel.style.display = 'block';
      elements.getCodeBtn.style.display = 'none';
      
      showToast('تم إنشاء طلبك بنجاح! يرجى إرسال الرمز للمصمم');
      
      // متابعة حالة الطلب
      trackOrderStatus(orderId);
    } catch (error) {
      showToast('حدث خطأ أثناء إنشاء الطلب');
      console.error("Order creation error:", error);
    }
  }

  async function sendToDesigner() {
    if (!currentOrder) return;
    
    try {
      await updateDoc(doc(db, 'design_orders', currentOrder.id), {
        status: 'sent',
        sentAt: serverTimestamp()
      });
      
      elements.clientMessages.innerHTML = `
        <div class="message">
          <p><i class="fas fa-check-circle" style="color:green"></i> تم إرسال طلبك للمصمم</p>
          <p>رقم الطلب: <strong>${currentOrder.id}</strong></p>
          <p>سيتم إعلامك عند اكتمال التصميم</p>
        </div>
      `;
      
      showToast('تم إرسال الطلب بنجاح للمصممين');
    } catch (error) {
      showToast('حدث خطأ أثناء إرسال الطلب');
      console.error("Send to designer error:", error);
    }
  }

  function trackOrderStatus(orderId) {
    onSnapshot(doc(db, 'design_orders', orderId), (doc) => {
      const order = doc.data();
      
      if (order.status === 'completed') {
        elements.clientMessages.innerHTML += `
          <div class="message">
            <p><i class="fas fa-check-circle" style="color:green"></i> تم اكتمال التصميم!</p>
            <p>ملاحظات المصمم: ${order.designerNotes || 'تم التعديل حسب طلبك'}</p>
          </div>
        `;
        
        elements.designResult.src = order.finalDesignUrl;
        elements.designResult.style.display = 'block';
        showToast('تم استلام التصميم النهائي');
      }
    });
  }

  function showToast(message) {
    elements.toast.textContent = message;
    elements.toast.classList.add('show');
    setTimeout(() => {
      elements.toast.classList.remove('show');
    }, 3000);
  }

  function changeLanguage() {
    lang = document.getElementById('langSelect').value;
    // يمكن إضافة تغيير النصوص هنا
  }
</script>
</body>
</html>